
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Redis on OSv - OSv Blog</title>
  <meta name="author" content="Cloudius Systems">

  
  <meta name="description" content="

  
  
    
      Redis on OSv
    
    
      
        










Aug 14, 2014
        
      
    
  


By Glauber Costa and Don Marti

We’re pl...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://osv-io.github.io//github/blog/2014/08/14/redis-memonly/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/monokai.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/customized.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="OSv Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/run_prettify.js" type="text/javascript"></script>
  <script src="/javascripts/lang-gas.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
<!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://osv.io/js/cycle.js"></script>
<script src="http://osv.io/js/js.js" language="javascript"></script-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43975320-1', 'osv.io');
  ga('send', 'pageview');
</script>

  

</head>

<body   >
  <div class="wrap">
  <div class="header"> <a class="logo" href="http://osv.io"><img src="http://osv.io/images/logo.jpg" /> </a>
    <div class="topMenu">
        <ul class="nav menu">
            <li><a href="http://osv.io">Home</a></li>
            <li class=""><a href="/">Blog</a></li>
            <li class=""><a href="/blog/archives">Archives</a></li>
        </ul>
        <ul class="subscription" data-subscription="rss">
            <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
            
        </ul>
        
        <form action="https://www.google.com/search" method="get">
            <fieldset role="search">
                <input type="hidden" name="q" value="site:http://osv-io.github.io//github" />
                <input class="search" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
        </form>
        
    </div>
</div>
<div class="mobile header">
    <a class="logo" href="http://osv.io/">
        <img src="http://osv.io/images/mobileLogo.jpg"/>
    </a>

    <div class="mobile-topMenu">
        <a href="javascript:void(0)" class="mobileMenuLink">&nbsp;</a>
        <div class="theMobileMenu">
            <ul class="nav menu">
                <li class=""><a href="" >Home</a></li>
                <li class="deeper parent"><a href="/users" >Users</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/dev" >Development</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/community" >Community</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li><a href="/contact/" >Contact</a></li>
            </ul>
        </div>
        <script>
            jQuery(document).ready(function(e) {
                $('.mobileMenuLink').click(function(e) {
                    $(this).toggleClass('active');
                    $('.theMobileMenu').slideToggle();
                });
            });
        </script>
    </div>
</div>
<div class="mobile mobilePageTitle">Redis on OSv</div>


  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Redis on OSv</h1>
    
    
      <p class="meta">
        










<time datetime="2014-08-14T12:26:31-04:00" pubdate data-updated="true">Aug 14, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>By Glauber Costa and Don Marti</strong></p>

<p>We’re planning to attend the 
Linux Foundation’s <a href="http://events.linuxfoundation.org/events/cloudopen-north-america">CloudOpen North America conference</a>.  Hope to see you there, and please come to our talk, “<a href="http://lccona14.sched.org/event/4684a80dd37f200277e971133920a2d0">Beating the Virtualization Tax for NoSQL Workloads With OSv</a>.”</p>

<p>We’ll be using a popular NoSQL database for our demo: Redis.  If you’d like to follow along, you’re welcome to clone and build Redis on OSv.  We’re big Redis fans, because it’s a fast, easy-to-administer, in-memory database that works with many useful data structures.</p>

<h2 id="redis-a-to-z">Redis A to Z</h2>

<p><a href="http://redis.io/">Redis</a> is a remarkably useful piece of software.  People on the Internet talk about Redis a lot.  Here’s what Google Suggest has to say about it: <strong>Atomic, benchmark, cluster, delete, expire, failover, gem, hash, incr, Java, key, list, master/slave, node.js, objects, Python, queue, Ruby, set, ttl, Ubuntu, “vs. mongodb”, Windows, XML, yum, zadd</strong>.  (<a href="http://redis.io/commands/ZADD">zadd</a> is a really cool command by the way.  A huge time-saver for maintaining “scoreboard” state for games and content-scoring applications.  Did we mention that we’re Redis fans?)</p>

<p>Redis fills a valuable niche between memcached and a full-scale NoSQL database such as Cassandra.  Although it’s fast and perfectly usable as a simple key-value store, you can also use Redis to manage more featureful data structures such as sets and queues.</p>

<p>It makes a great session cache, lightweight task queue, or a place to keep pre-rendered content or ephemeral data, and it’s a <a href="http://highscalability.com/display/Search?moduleId=4876569&amp;searchQuery=redis">star at highscalability.com</a>.</p>

<p>But you probably already know that.</p>

<h2 id="building-redis-on-osv">Building Redis on OSv</h2>

<p>Redis works normally on OSv except for one feature: the
<a href="http://redis.io/commands/bgsave">BGSAVE</a>
command.  A Redis background
save depends on the operating system’s
<a href="http://en.wikipedia.org/wiki/Copy-on-write#Copy-on-write_in_virtual_memory_management">copy-on-write</a>
functionity.  When you issue the BGSAVE
command, the parent Redis process calls
<a href="http://en.wikipedia.org/wiki/Fork_%28system_call%29">fork</a>,
and the parent process keeps running while the child
process saves the database state.</p>

<p>Copy-on-write ensures that the child process sees
a consistent set of data, while the parent gets its
own copy of any page that it modifies.</p>

<p>Because OSv has a single address space,
that isn’t an option here. OSv support Redis
<a href="http://redis.io/commands/save">SAVE</a> but not BGSAVE. Other than that,
running redis on OSv requires little effort. From the OSv source tree,
all one should do is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make image=redis-memonly
</code></pre></div></div>

<p>Now you have a <code class="highlighter-rouge">usr.img</code> file, which you can run locally with OSv’s <code class="highlighter-rouge">run.py</code>.  Behind the scenes, all that this build step is doing is to issue the application’s <code class="highlighter-rouge">make</code>, with the right set of flags so redis is a shared library.  For more info on how to do that, see <a href="http://osv.io/blog/blog/2014/04/03/capstan/">our earlier example</a>.  of how to use the <code class="highlighter-rouge">-fPIC</code> and <code class="highlighter-rouge">-shared</code> options.</p>

<h2 id="is-it-fast">Is it fast?</h2>

<p>We have been running redis on local machines to test many of its
functionalities and help us mature OSv.  As with any piece of software, the
result of course depends on many factors.  Because OSv is an operating system
designed for the cloud, we wanted to showcase its performance running on Amazon
EC2.</p>

<p>To do that, we have selected the <a href="http://aws.amazon.com/ec2/instance-types/">c3.x8large</a> machines.  They feature 32 CPUs and
60Gb of memory each. We are fully aware this is an overkill in the case
of Redis - a single threaded application. However, those are the only machines
that Amazon advertises as featuring 10Gb networking, and we didn’t want the
network to be a bottleneck for the sake of the benchmark. Also, smaller
machines cannot be put in EC2 placement groups. It all boils down to the network!</p>

<p>So in this benchmark, no more than two cores should be active at any given time - one for redis, one for network interrupt processing. In a real scenario, one could easily deploy in a smaller machine.</p>

<h3 id="benchmark-setup">Benchmark setup</h3>

<p>We have benchmarked redis’ latest beta (beta-8) running both on OSv, and on an
Ubuntu14 AMI. To do that, we have just launched a new AMI, selected
Ubuntu14.04, and launched it. Once it launched, we have downloaded and compiled
redis’ latest, and moved the redis.conf used by OSv to the machine. The only
difference in that configuration file from what is shipped with redis by
default, is that we disable disk activity. As already explained,
OSv currently do not support that, and to be fair, the Linux guest we are
comparing against should not hit the disk either at any point.</p>

<p>On ubuntu, redis was run with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>numactl --physcpubind=1 redis-server ~/redis.conf
</code></pre></div></div>

<p>Using numactl considerably reduces the standard deviation coming from the Linux
scheduler moving the thread around.</p>

<p>The <code class="highlighter-rouge">redis-benchmark</code> command was issued in another machine of the same type,
running in the same zone and placement group.</p>

<p>The two commands were:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>numactl --physcpubind=1 redis-benchmark --csv -h &lt;IP&gt; -c 50 -n 100000 -P 1
</code></pre></div></div>

<p>and later on, to demonstrate how OSv can handle larger messages,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>numactl --physcpubind=1 redis-benchmark --csv -h &lt;IP&gt; -c 50 -n 100000 -P 16
</code></pre></div></div>

<p>What this last command does, is to exercise redis’ <code class="highlighter-rouge">pipeline</code> feature, that
can send multiple - in this case 16 - commands in the same packet. This will
decrease the impact of the round trip time in the final figure.</p>

<p>The difference can be clearly seen in the graph…</p>

<p><a href="/images/redis.png"><img src="/images/redis.png" alt="Redis benchmark results" /></a></p>

<p>Note that the LRANGE class of commands has a significantly different pattern
than the other commands. In that command, the client sends a very short query,
and receive a potentially very large reply, thereby exercising the transmission
path, rather than the receive path of OSv. This table shows that our transmission
path is lacking a bit of love, particularly when the response sizes grows (as the
pipeline level increases)</p>

<h2 id="conclusions">Conclusions</h2>

<p>OSv is a fast maturing, but not yet mature operating system, soon to be in beta
phase. We have gaps to close, as can be seen in the case of LRANGE set of
benchmarks. So far, we have focused our efforts in technologies around the
receive path, and it has paid off: We can offer a level of performance far
beyond what an out of the box distribution can. Some features that we
architecturally lack, makes the use of Redis as a full-blown on-disk database
challenging. But if you want to serve your load from memory, the OSv promise
delivers: With OSv, you don’t have to pay the virtualization tax.</p>

<p>If you’ll be at CloudOpen, you can <a href="http://lccona14.sched.org/event/4684a80dd37f200277e971133920a2d0">add our talk to your schedule now</a>.</p>

<p>If you have any questions on running Redis or any other application, please join the <a href="https://groups.google.com/forum/#!forum/osv-dev">osv-dev mailing list</a>.  You can get general updates by subscribing to this blog’s <a href="http://osv.io/blog/atom.xml">feed</a>, or folllowing <a href="https://twitter.com/CloudiusSystems">@CloudiusSystems</a> on Twitter.</p>

</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Cloudius Systems</span></span>

      










<time datetime="2014-08-14T12:26:31-04:00" pubdate data-updated="true">Aug 14, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/nosql/'>nosql</a>
  
</span>


    </p>
    
      <div class="sharing">
    <div class="addthis_toolbox addthis_default_style ">
        
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        
        
        <a class="addthis_button_tweet"></a>
        
        
        
        <a class="addthis_counter addthis_pill_style"></a>
        
    </div>
    
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-5343e81a2e0c9bfa"></script>
    
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/27/capstan-lein-template/" title="Previous Post: Running Clojure on OSv: easier with a new Capstan template">&laquo; Running Clojure on OSv: easier with a new Capstan template</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/20/linuxcon-cloudopen/" title="Next Post: OSv in the spotlight at LinuxCon/CloudOpen 2014">OSv in the spotlight at LinuxCon/CloudOpen 2014 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/04/19/making-OSv-run-on-firecraker/">Making OSv Run on Firecracker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/12/serverless-computing-with-OSv/">Serverless Computing With OSv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/21/nfs-on-osv/">NFS on OSv or “How I Learned to Stop Worrying About Memory Allocations and Love the Unikernel”</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/08/project-mikelangelo/">Project Mikelangelo Update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/docker/">Building OSv Images Using Docker</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  </div>
  <div class="footer">
    <div class="wrapf">


        <div class="custom"  >
            <p><a href="http://www.cloudius-systems.com"><img style="margin-top: 30px;" src="http://osv.io/images/footerLogo.jpg" alt="" width="380" height="38" /></a></p></div>



        <div class="custom social"  >
            <p><a href="https://plus.google.com/107787008629542080430" rel="publisher">Google+</a></p></div>



        <div class="custom CloudIcon"  >
            <p><a href="/index.php"><img src="http://osv.io/images/footerCloudIcon.jpg" width="57" height="33" alt="footerCloudIcon" /></a></p></div>

        <div class="clr"></div>
    </div>
</div>


  

<script type="text/javascript">
      var disqus_shortname = 'osvblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.osv.io//github/blog/2014/08/14/redis-memonly/';
        var disqus_url = 'http://blog.osv.io//github/blog/2014/08/14/redis-memonly/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
