
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building OSv Images Using Docker - OSv Blog</title>
  <meta name="author" content="Cloudius Systems">

  
  <meta name="description" content="By David Jorm and Don Marti Why build OSv images under Docker? Building OSv from source has several advantages, including the ability to build images &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.osv.io//github/blog/2015/04/27/docker">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="OSv Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
<!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://osv.io/js/cycle.js"></script>
<script src="http://osv.io/js/js.js" language="javascript"></script-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43975320-1', 'osv.io');
  ga('send', 'pageview');
</script>

  

</head>

<body   >
  <div class="wrap">
  <div class="header"> <a class="logo" href="http://osv.io"><img src="http://osv.io/images/logo.jpg" /> </a>
    <div class="topMenu">
        <ul class="nav menu">
            <li><a href="http://osv.io">Home</a></li>
            <li class=""><a href="/">Blog</a></li>
            <li class=""><a href="/blog/archives">Archives</a></li>
        </ul>
        <ul class="subscription" data-subscription="rss">
            <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
            
        </ul>
        
        <form action="https://www.google.com/search" method="get">
            <fieldset role="search">
                <input type="hidden" name="q" value="site:blog.osv.io//github" />
                <input class="search" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
        </form>
        
    </div>
</div>
<div class="mobile header">
    <a class="logo" href="http://osv.io/">
        <img src="http://osv.io/images/mobileLogo.jpg"/>
    </a>

    <div class="mobile-topMenu">
        <a href="javascript:void(0)" class="mobileMenuLink">&nbsp;</a>
        <div class="theMobileMenu">
            <ul class="nav menu">
                <li class=""><a href="" >Home</a></li>
                <li class="deeper parent"><a href="/users" >Users</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/dev" >Development</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/community" >Community</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li><a href="/contact/" >Contact</a></li>
            </ul>
        </div>
        <script>
            jQuery(document).ready(function(e) {
                $('.mobileMenuLink').click(function(e) {
                    $(this).toggleClass('active');
                    $('.theMobileMenu').slideToggle();
                });
            });
        </script>
    </div>
</div>
<div class="mobile mobilePageTitle">Building OSv images using Docker</div>


  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building OSv Images Using Docker</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-27T00:00:00+03:00" pubdate data-updated="true">Apr 27<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>By David Jorm and Don Marti</strong></p>

<h2>Why build OSv images under Docker?</h2>

<p>Building OSv from source has several advantages, including the ability to build images targeting different execution environments. The <a href="https://cloudrouter.org">CloudRouter project</a> is working on integrating the build script into its continuous integration system, automatically producing nightly rebuilds of all supported OSv application images.</p>

<p>The main problem with this approach is that it requires a system to be appropriately configured with all the necessary dependencies and source code to run builds. To build a scalable and reproducible continuous integration system, we really want to automate the provisioning of new build servers. An ideal way to achieve this goal is by creating a Docker image that includes all the necessary components to produce OSv image builds.</p>

<h2>osv-builder: a Docker based build/development environment for OSv</h2>

<p>The <a href="https://registry.hub.docker.com/u/cloudrouter/osv-builder/">osv-builder Docker image</a> provides a complete build and development environment for OSv, including OSv application images and appliances. It has been developed by <a href="https://github.com/abn/">Arun Babu Neelicattu</a> from <a href="http://iix.net">IIX</a>. To download the image, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker pull cloudrouter/osv-builder
</span></code></pre></td></tr></table></div></figure>


<p>OSv includes a range of <a href="https://github.com/cloudius-systems/osv/tree/master/scripts">helper scripts</a> for building and running OSv images. The build script will compile OSv from the local source tree, then create a complete OSv image for a given application, based on the application’s Makefile. For more on <code>scripts/build</code>, see <a href="http://osv.io/blog/blog/2015/04/08/makefile/">the recent blog post on the OSv build system</a>.</p>

<h2>Capstan</h2>

<p>The image comes with Capstan pre-installed. Note that to use Capstan, you&rsquo;ll have to run the container with the &mdash;privileged option, as it requires the KVM kernel module. For example, to build and run the iperf application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo docker run -it <span class="se">\</span>
</span><span class='line'>  --privileged <span class="se">\</span>
</span><span class='line'>  cloudrouter/osv-builder
</span><span class='line'>bash-4.3# <span class="nb">cd </span>apps/iperf
</span><span class='line'>bash-4.3# capstan build
</span><span class='line'>Building iperf...
</span><span class='line'>Downloading cloudius/osv-base/index.yaml...
</span><span class='line'>154 B / 154 B <span class="o">[=================================================================================================================]</span> 100.00 % 0
</span><span class='line'>Downloading cloudius/osv-base/osv-base.qemu.gz...
</span><span class='line'>20.09 MB / 20.09 MB <span class="o">[=======================================================================================================]</span> 100.00 % 1m27s
</span><span class='line'>Uploading files...
</span><span class='line'>1 / 1 <span class="o">[=========================================================================================================================]</span> 100.00 % bash-4.3# capstan run
</span><span class='line'>Created instance: iperf
</span><span class='line'>OSv v0.19
</span><span class='line'>eth0: 192.168.122.15
</span><span class='line'>------------------------------------------------------------
</span><span class='line'>Server listening on TCP port 5001
</span><span class='line'>TCP window size: 64.0 KByte <span class="o">(</span>default<span class="o">)</span>
</span><span class='line'>------------------------------------------------------------
</span></code></pre></td></tr></table></div></figure>


<h2>Launching an interactive session</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">HOST_BUILD_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/build
</span><span class='line'>docker run -it <span class="se">\</span>
</span><span class='line'>  --volume <span class="k">${</span><span class="nv">HOST_BUILD_DIR</span><span class="k">}</span>:/osv/builder <span class="se">\</span>
</span><span class='line'>  cloudrouter/osv-builder
</span></code></pre></td></tr></table></div></figure>


<p>This will place you into the OSv source clone.  You’ll see the prompt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bash-4.3#
</span></code></pre></td></tr></table></div></figure>


<p>Now, you can work with it as you normally would when working on OSv source.  You can build apps, edit build scripts, and so on. For example, you can run the following commands, once the above <code>docker run</code> commands has been executed, to build and run a tomcat appliance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>./scripts/build <span class="nv">image</span><span class="o">=</span>tomcat,httpserver
</span><span class='line'>./scripts/run -V
</span></code></pre></td></tr></table></div></figure>


<h2>The <code>osv</code> Command</h2>

<p><strong>Note</strong> that the commands you run can be prefixed with <code>osv</code>, the source for which is available at <code>assets/osv</code>. For example you can build by:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker run <span class="se">\</span>
</span><span class='line'>  --volume <span class="k">${</span><span class="nv">HOST_BUILD_DIR</span><span class="k">}</span>:/osv/build <span class="se">\</span>
</span><span class='line'>  osv-builder <span class="se">\</span>
</span><span class='line'>  osv build <span class="nv">image</span><span class="o">=</span>opendaylight
</span></code></pre></td></tr></table></div></figure>


<p>The <code>osv</code> script, by default, provides the following convenience wrappers:</p>

<table>
<thead>
<tr>
<th></th>
<th align="left"> Command                                     </th>
<th align="left"> Mapping</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> build <em>args</em>                                </td>
<td align="left"> scripts/build </td>
</tr>
<tr>
<td></td>
<td align="left"> run <em>args</em>                                  </td>
<td align="left"> scripts/run.py</td>
</tr>
<tr>
<td></td>
<td align="left"> appliance <em>name</em> <em>components</em> <em>description</em> </td>
<td align="left"> scripts/build-vm-img</td>
</tr>
<tr>
<td></td>
<td align="left"> clean                                       </td>
<td align="left"> make clean</td>
</tr>
</tbody>
</table>


<p>If any other command is used, it is simply passed on as <code>scripts/$CMD "$@"</code> where <code>$@</code> is the arguments following the command.</p>

<p>You could also run commands as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker run <span class="se">\</span>
</span><span class='line'>  --volume <span class="k">${</span><span class="nv">HOST_BUILD_DIR</span><span class="k">}</span>:/osv/build <span class="se">\</span>
</span><span class='line'>  osv-builder <span class="se">\</span>
</span><span class='line'>  ./scripts/build <span class="nv">image</span><span class="o">=</span>opendaylight
</span></code></pre></td></tr></table></div></figure>


<h2>Building appliance images</h2>

<p>If using the pre-built version from Docker Hub, use <code>cloudrouter/osv-builder</code> instead of <code>osv-builder</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">HOST_BUILD_DIR</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/build
</span><span class='line'>docker run <span class="se">\</span>
</span><span class='line'>  --volume <span class="k">${</span><span class="nv">HOST_BUILD_DIR</span><span class="k">}</span>:/osv/build <span class="se">\</span>
</span><span class='line'>  osv-builder <span class="se">\</span>
</span><span class='line'>  osv appliance zookeeper apache-zookeeper,cloud-init <span class="s2">&quot;Apache Zookeeper on OSv&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If everything goes well, the images should be available in <code>${HOST_BUILD_DIR}</code>. This will contain appliance images for <a href="http://wiki.qemu.org/KVM">QEMU/KVM</a>, <a href="https://www.virtualbox.org/">Oracle VirtualBox</a>, <a href="https://cloud.google.com/compute/">Google Compute Engine</a> and <a href="https://www.vmware.com/">VMWare</a> Virtual Machine Disk.</p>

<p>Note that we explicitly disable the build of <a href="http://www.vmware.com/products/esxi-and-esx/overview">VMware ESXi</a> images since <code>ovftool</code> is not available.</p>

<h2>Building locally</h2>

<p>As an alternative, you can build locally with a <code>docker build</code> command, using the <a href="https://registry.hub.docker.com/u/cloudrouter/osv-builder/dockerfile/">Dockerfile</a> for osv-builder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>docker build -t osv-builder .
</span></code></pre></td></tr></table></div></figure>


<p>Then you can use a plain <code>osv-builder</code> image name instead of <code>cloudrouter/osv-builder</code>.</p>

<p>For more information regarding OSv Appliances and pre-built ones, check the <a href="http://osv.io/virtual-appliances/">OSv virtual appliances page</a>.</p>

<h2>Volume Mapping</h2>

<table>
<thead>
<tr>
<th></th>
<th align="left"> Volume      </th>
<th align="left"> Description                                                               </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td align="left"> /osv        </td>
<td align="left"> This directory contains the OSv repository.</td>
</tr>
<tr>
<td></td>
<td align="left"> /osv/apps   </td>
<td align="left"> The OSv apps directory. Mount this if you are testing local applications.</td>
</tr>
<tr>
<td></td>
<td align="left"> /osv/build  </td>
<td align="left"> The OSv build directory containing release and standalone directories.</td>
</tr>
<tr>
<td></td>
<td align="left"> /osv/images </td>
<td align="left"> The OSv image build configurations.</td>
</tr>
</tbody>
</table>


<h2>Sending OSv patches</h2>

<p>If you’re following the <a href="https://github.com/cloudius-systems/osv/wiki/Formatting-and-sending-patches">Formatting and sending patches</a> guide on the OSv web site, just copy your patches into the <code>builder</code> directory in the container, and they’ll show up under your <code>$HOST_BUILD_DIR</code>, ready to be sent to the mailing list.</p>

<h2>Conclusion</h2>

<p>With the osv-builder docker image, building your own OSv images is now easier than ever before. If you are looking for a high-performance operating system to run your applications, go ahead and give it a try!</p>

<p>Questions and comments welcome on the <a href="https://groups.google.com/forum/#!forum/osv-dev">osv-dev mailing list</a>.</p>

<h2>About the authors</h2>

<p><strong>David</strong> is a product security engineer based in Brisbane, Australia. He currently leads product security efforts for IIX, a software-defined interconnection company. David has been involved in the security industry for the last 15 years. During this time he has found high-impact and novel flaws in dozens of major Java components. He has worked for Red Hat’s security team, led a Chinese startup that failed miserably, and wrote the core aviation meteorology system for the southern hemisphere. In his spare time he tries to stop his two Dachshunds from taking over the house.</p>

<p><strong>Don</strong> is a technical marketing manager for Cloudius Systems, the OSv company. He has written for Linux Weekly News, Linux Journal, and other publications. He co-founded the Linux consulting firm Electric Lichen, which was acquired by VA Linux Systems. Don has served as president and vice president of the Silicon Valley Linux Users Group and on the program committees for Uselinux, Codecon, and LinuxWorld Conference and Expo.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Cloudius Systems</span></span>

      








  


<time datetime="2015-04-27T00:00:00+03:00" pubdate data-updated="true">Apr 27<span>th</span>, 2015</time>
      


    </p>
    
      <div class="sharing">
    <div class="addthis_toolbox addthis_default_style ">
        
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        
        
        <a class="addthis_button_tweet"></a>
        
        
        <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
        
        
        <a class="addthis_counter addthis_pill_style"></a>
        
    </div>
    
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-5343e81a2e0c9bfa"></script>
    
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/04/08/makefile/" title="Previous Post: Re-"make"-ing OSv">&laquo; Re-"make"-ing OSv</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/03/08/project-mikelangelo/" title="Next Post: Project Mikelangelo update">Project Mikelangelo update &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/06/12/serverless-computing-with-OSv/">Serverless Computing With OSv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/21/nfs-on-osv/">NFS on OSv or “How I Learned to Stop Worrying About Memory Allocations and Love the Unikernel”</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/08/project-mikelangelo/">Project Mikelangelo Update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/docker/">Building OSv Images Using Docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/08/makefile/">Re-"make"-ing OSv</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  </div>
  <div class="footer">
    <div class="wrapf">


        <div class="custom"  >
            <p><a href="http://www.cloudius-systems.com"><img style="margin-top: 30px;" src="http://osv.io/images/footerLogo.jpg" alt="" width="380" height="38" /></a></p></div>



        <div class="custom social"  >
            <p><a href="https://plus.google.com/107787008629542080430" rel="publisher">Google+</a></p></div>



        <div class="custom CloudIcon"  >
            <p><a href="/index.php"><img src="http://osv.io/images/footerCloudIcon.jpg" width="57" height="33" alt="footerCloudIcon" /></a></p></div>

        <div class="clr"></div>
    </div>
</div>


  

<script type="text/javascript">
      var disqus_shortname = 'osvblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
