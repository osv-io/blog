
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Re-"make"-ing OSv - OSv Blog</title>
  <meta name="author" content="Cloudius Systems">

  
  <meta name="description" content="

  
  
    
      Re-"make"-ing OSv
    
    
      
        










Apr 8, 2015
        
      
    
  


OSv 0.19 is out, with a rewrite of t...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://osv-io.github.io//github/blog/2015/04/08/makefile/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/monokai.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/customized.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/atom.xml" rel="alternate" title="OSv Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/run_prettify.js" type="text/javascript"></script>
  <script src="/javascripts/lang-gas.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
<!--script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="http://osv.io/js/cycle.js"></script>
<script src="http://osv.io/js/js.js" language="javascript"></script-->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43975320-1', 'osv.io');
  ga('send', 'pageview');
</script>

  

</head>

<body   >
  <div class="wrap">
  <div class="header"> <a class="logo" href="http://osv.io"><img src="http://osv.io/images/logo.jpg" /> </a>
    <div class="topMenu">
        <ul class="nav menu">
            <li><a href="http://osv.io">Home</a></li>
            <li class=""><a href="/">Blog</a></li>
            <li class=""><a href="/blog/archives">Archives</a></li>
        </ul>
        <ul class="subscription" data-subscription="rss">
            <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
            
        </ul>
        
        <form action="https://www.google.com/search" method="get">
            <fieldset role="search">
                <input type="hidden" name="q" value="site:http://osv-io.github.io//github" />
                <input class="search" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
        </form>
        
    </div>
</div>
<div class="mobile header">
    <a class="logo" href="http://osv.io/">
        <img src="http://osv.io/images/mobileLogo.jpg"/>
    </a>

    <div class="mobile-topMenu">
        <a href="javascript:void(0)" class="mobileMenuLink">&nbsp;</a>
        <div class="theMobileMenu">
            <ul class="nav menu">
                <li class=""><a href="" >Home</a></li>
                <li class="deeper parent"><a href="/users" >Users</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/dev" >Development</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li class="deeper parent"><a href="/community" >Community</a>
                    <ul class="nav-child unstyled small">
                        
                    </ul>
                </li>
                <li><a href="/contact/" >Contact</a></li>
            </ul>
        </div>
        <script>
            jQuery(document).ready(function(e) {
                $('.mobileMenuLink').click(function(e) {
                    $(this).toggleClass('active');
                    $('.theMobileMenu').slideToggle();
                });
            });
        </script>
    </div>
</div>
<div class="mobile mobilePageTitle">Re-"make"-ing OSv</div>


  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Re-"make"-ing OSv</h1>
    
    
      <p class="meta">
        










<time datetime="2015-04-08T00:00:00-04:00" pubdate data-updated="true">Apr 8, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="https://groups.google.com/forum/#!topic/osv-dev/x-E9YfzDz20">OSv 0.19</a> is out, with a rewrite of the build system. The old OSv build system was fairly complex, but the rewrite makes it simpler and faster.</p>

<h2 id="simpler-makefile">Simpler Makefile</h2>

<p>The old OSv build system had several makefiles including each other, playing tricks with the current directory and <code class="highlighter-rouge">VPATH</code>, dynamically rewriting makefiles, and running submakes.</p>

<p>The old <code class="highlighter-rouge">Makefile</code> was responsible not only for building the kernel, it also built tests, called various Python scripts to build modules for different applications, and carried out other tasks.</p>

<p>In the new build system, there is just one “Makefile” for building the entire OSv kernel. Everything is in one file, and also better commented.</p>

<h2 id="separate-kernel-building-from-application-building">Separate kernel building from application building</h2>

<p>In the old build system, we used “make” to do everything from building the OSv kernel, building various applications, and building images containing OSv and a collection of applications. This complicated the <code class="highlighter-rouge">Makefile</code>, and resulted in unexpected build requirements. For example, building OSv always built some Java tests and thus required Maven and a working Internet connection).</p>

<p>In the new system, <code class="highlighter-rouge">make</code> only builds the OSv kernel, and <code class="highlighter-rouge">scripts/build</code>
build applications and images. In the future, you could use <a href="http://osv.io/capstan/">Capstan</a> instead of <code class="highlighter-rouge">scripts/build</code> to make an image that you would like to manage with Capstan.</p>

<p>Most <code class="highlighter-rouge">make</code> command lines that worked in the previous build system will
continue to work unchanged with <code class="highlighter-rouge">scripts/build</code>. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># build image with default OSv application
scripts/build

# build the rogue image
scripts/build image=rogue
# or
scripts/build modules=rogue

# clean kernel and all modules
scripts/build clean

# make parameters can also be given to build
scripts/build mode=debug

# build image with tests, and run them
scripts/build check
</code></pre></div></div>

<p> </p>

<p>Additional benefits of this rewrite include:</p>

<ol>
  <li>
    <p>Faster rebuilds. For example “touch loader.cc; scripts/build image=rogue”
takes just 6 seconds (14 seconds previously). make after “make clean”
(with ccache) is just 10 seconds (30 seconds previously).</p>
  </li>
  <li>
    <p>It should be fairly easy to add additional
build scripts which will build different types of images using the same
OSv kernel. One popularly requested option is to have the ability to
create a bootfs-only image, without ZFS.</p>
  </li>
  <li>
    <p>Some smaller improvements, like more accurate setting of the desired image size <a href="https://github.com/cloudius-systems/osv/issues/595">(covered in issue #595)</a>, and supporting setting CROSS_PREFIX without also needing to specify ARCH.</p>
  </li>
</ol>

<h2 id="what-happened-to-make-test">What happened to <code class="highlighter-rouge">make test</code>?</h2>

<p>The OSv test are a module like other modules - they won’t be compiled unless someone builds the <code class="highlighter-rouge">tests</code> module. They will have a separate Makefile in <code class="highlighter-rouge">tests/</code>. The <code class="highlighter-rouge">ant</code> and <code class="highlighter-rouge">mvn</code> tools, both currently used in our makefile just for building tests, will no longer be run every time the kernel is compiled, but just when the “tests” module is being built. To build and run the tests:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scripts/build check
</code></pre></div></div>

<h2 id="try-it-out">Try it out</h2>

<p>The good news is that now, running <code class="highlighter-rouge">make</code> is faster, and the image build process is simpler and easier to extend. Check it out – questions and comments welcome on the <a href="https://groups.google.com/forum/#!forum/osv-dev">osv-dev mailing list</a>.</p>

</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Cloudius Systems</span></span>

      










<time datetime="2015-04-08T00:00:00-04:00" pubdate data-updated="true">Apr 8, 2015</time>
      


    </p>
    
      <div class="sharing">
    <div class="addthis_toolbox addthis_default_style ">
        
        <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
        
        
        <a class="addthis_button_tweet"></a>
        
        
        
        <a class="addthis_counter addthis_pill_style"></a>
        
    </div>
    
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=ra-5343e81a2e0c9bfa"></script>
    
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/04/03/cloudrouter/" title="Previous Post: Wiki watch: CloudRouter images available">&laquo; Wiki watch: CloudRouter images available</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/04/27/docker/" title="Next Post: Building OSv images using Docker">Building OSv images using Docker &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/04/19/making-OSv-run-on-firecraker/">Making OSv Run on Firecracker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/12/serverless-computing-with-OSv/">Serverless Computing With OSv</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/21/nfs-on-osv/">NFS on OSv or “How I Learned to Stop Worrying About Memory Allocations and Love the Unikernel”</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/03/08/project-mikelangelo/">Project Mikelangelo Update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/docker/">Building OSv Images Using Docker</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  </div>
  <div class="footer">
    <div class="wrapf">


        <div class="custom"  >
            <p><a href="http://www.cloudius-systems.com"><img style="margin-top: 30px;" src="http://osv.io/images/footerLogo.jpg" alt="" width="380" height="38" /></a></p></div>



        <div class="custom social"  >
            <p><a href="https://plus.google.com/107787008629542080430" rel="publisher">Google+</a></p></div>



        <div class="custom CloudIcon"  >
            <p><a href="/index.php"><img src="http://osv.io/images/footerCloudIcon.jpg" width="57" height="33" alt="footerCloudIcon" /></a></p></div>

        <div class="clr"></div>
    </div>
</div>


  

<script type="text/javascript">
      var disqus_shortname = 'osvblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
